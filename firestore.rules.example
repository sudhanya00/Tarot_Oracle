rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{uid}/chats/{chatId} {
      allow read, write: if request.auth != null && request.auth.uid == uid;

      // Hard cap messages length to 25 on writes (defense-in-depth)
      function isValidMessages(messages) {
        return messages.size() <= 25;
      }

      allow update: if request.resource.data.messages == null || isValidMessages(request.resource.data.messages);
    }
  }
}
